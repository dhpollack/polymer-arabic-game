<link rel="import" href="../../bower_components/polymer/polymer.html">
<!-- Additional Component Load -->
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<dom-module id="letter-service">
  <style>
  iron-ajax {
    display: none;
  }
  </style>
  <template>
    <iron-ajax id="ajax" 
      url="{{jsonUrl}}" 
      handleas="json" 
      on-request="lettersRequest"
      on-response="lettersLoaded">
    </iron-ajax>
  </template>
</dom-module>
<script>
(function() {
  Polymer({
    is: 'letter-service',

    properties: {
      currlang: {
        type: String,
        notify: true
      },
      lobj: {
        type: Object,
        notify: true,
        value: function () { return {}; }
      },
      jsonUrl: {
        type: String,
        value: ""
      }
    },
    listeners: {
      'currlang-changed': 'changeJsonUrl'
    },
    attached: function() {
      this.jsonUrl = this.createJsonUrl(this.currlang);
      this.$.ajax.auto = true;
    },
    changeJsonUrl: function(ev) {
      this.jsonUrl = this.createJsonUrl(this.currlang);
    },
    createJsonUrl: function(langCode) {
      if(langCode == undefined) {
        return "/api/ar/letters.json";
      } else {
        return "/api/"+langCode+"/letters.json";
      }
    },
    lettersRequest: function() {
      if(!this.letterListBox) {
        this.letterListBox = document.querySelector("letter-list");
      }
      this.letterListBox.setLetters = false;
    },
    lettersLoaded: function() {
      var jsonSuccess = (this.$.ajax.lastResponse != null) ? true : false;
      console.log("loading letters from url: " + this.jsonUrl + " \nSuccess: " + jsonSuccess);
      // Make a copy of the loaded data
      if(jsonSuccess) {
        var ajaxData = this.$.ajax.lastResponse.slice()[0];
        this.lobj = ajaxData;
        this.fire('new-letters', { jsonLang:  ajaxData.lang.code });
        this.fire('lang-help', {langHtml: ajaxData.lang.langHelpInfo})
        this.letterListBox.setLetters = true;
      }
    }
  });
})();
</script>