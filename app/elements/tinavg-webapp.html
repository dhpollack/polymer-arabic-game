<link rel="import" href="../../bower_components/polymer/polymer.html">
<!-- Additional Component Load -->
<!-- Layout/Polymer Elements -->
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">
<!-- Custom Elements -->
<link rel="import" href="elements.html">
<!-- keyboard shortcuts -->
<script src="../assets/js/mousetrap.min.js"></script>
<dom-module id="tinavg-webapp">
  <style is="custom-style">
    /*
    paper-toggle-button {
      --paper-toggle-button-unchecked-bar-color: #FF4081;
      --paper-toggle-button-unchecked-button-color: #9c27b0;
      --paper-toggle-button-unchecked-ink-color: #009688;
      --paper-toggle-button-checked-bar-color: #5677fc;
      --paper-toggle-button-checked-button-color: #ff4081;
      --paper-toggle-button-checked-ink-color: #ff4081;
    }
    */
  </style>
  <template>
    <iron-localstorage name="tinavg-lastlang" value="{{currLang}}"></iron-localstorage>
    <iron-localstorage name="tinavg-earmodus" value="{{earmodus}}"></iron-localstorage>
    <iron-localstorage name="tinavg-learnmodus" value="{{learnmodus}}"></iron-localstorage>
    <iron-localstorage name="tinavg-recordmodus" value="{{recordmodus}}"></iron-localstorage>
    <iron-localstorage name="tinavg-nerdmodus" value="{{nerdmodus}}"></iron-localstorage>
    <iron-localstorage name="tinavg-nerdsprache" value="{{nerdSprache}}"></iron-localstorage>
    <paper-drawer-panel id="pdp" responsive-width="25000px" right-drawer>
      <div id="collapse" class="mini-menu" drawer>
        <div>
          Language: 
          <select on-change="setLang">
            <option value="de">German</option>
            <option value="en">English</option>
            <option value="en-US-south">English (US South)</option>
            <option value="ar">Arabic</option>
            <option value="ko">Korean</option>
            <option value="ru">Russian</option>
            <option value="he">Hebrew</option>
            <!--
            <option value="tr">Turkish</option>
            -->
          </select>
        </div>
        <br /><div>Earmodus: <paper-toggle-button id="select_earmodus" on-tap="toggleEarModus" checked$="{{earmodus}}"></paper-toggle-button></div>
        <br /><div>Learnmodus: <paper-toggle-button id="select_learnmodus" on-tap="toggleLearnModus" checked$="{{learnmodus}}"></paper-toggle-button></div>
        <br /><div>Meiselmodus: <paper-toggle-button id="select_nerdmodus" on-tap="toggleNerdModus" checked$="{{nerdmodus}}"></paper-toggle-button></div>
        <br /><div>
          Meiselsprache: 
          <select id="meiselspracheliste" on-change="setNerdSprache" disabled$="{{!nerdmodus}}">
            <option value="de">German</option>
            <option value="en">English</option>
            <option value="ar">Arabic</option>
            <option value="ko">Korean</option>
            <option value="ru">Russian</option>
            <option value="he">Hebrew</option>
            <option value="tr">Turkish</option>
          </select>
        </div>
        <div><br />Talkmodus: <paper-toggle-button id="select_recordmodus" on-tap="toggleRecordModus" checked$="{{recordmodus}}"></paper-toggle-button></div>
        <div hidden><br />BuggyFill: <paper-toggle-button id="select_buggyfill" on-tap="refreshBuggyFill"></paper-toggle-button></div>
      </div>
      <paper-header-panel id="header-panel" main>
        <div class="two-headers paper-header">
          <div class="footer horizontal justified layout center">
            <div class="footer-button horizontal start-justified layout flex">
              <score-board id="score-board-player-1" player="1" learnmodus="{{learnmodus}}" recordmodus="{{recordmodus}}"></score-board>
            </div>
            <word-board id="wboard" class="horizontal center-justified layout flex-2" lang-code="{{currLang}}" earmodus="{{earmodus}}"></word-board>
            <div class="horizontal end-justified layout flex">
              <iron-icon id="menutoggle" class="spin-flip-transition tinavg-med-icon big" icon="menu" paper-drawer-toggle></iron-icon>
            </div>
          </div>
          <div class="core-header horizontal justified layout center">
            <div class="top-right-item horizontal start-justified layout flex">
              <iron-icon id="help-show" class="tinavg-med-icon" icon="help" on-tap="showHelp"></iron-icon>
              <lang-flag id="switchModusIcon" mylang="[[currLang]]" langs="[[languageList]]" on-tap="switchModus"></lang-flag>
            </div>
            <div class="horizontal center-justified layout flex-2">
              <jumbotron-text id="jt" tabindex="{{jumbotronIndex}}" learnmodus="{{learnmodus}}"></jumbotron-text>
            </div>
            <div id="nerdmodus-div" class="horizontal end-justified layout flex">
              <score-board id="score-board-player-2" player="2" hidden></score-board>
              <div id="clue-show-div" class="tinavg-med-icon"><iron-icon id="clueshow" class="spin-flip-transition tinavg-med-icon" icon="text-format" on-tap="showClue"></iron-icon></div>
            </div>
          </div>
        </div>
        <div id="maincontentarea" class="content">
          <word-recorder id="wrecorder" hidden$="{{!recordmodus}}"></word-recorder>
          <letter-list id="lettergrid" limit="{{letterLimit}}" lang-code="{{currLang}}" hidden$="{{recordmodus}}"></letter-list>
          <simple-overlay id="so" opened="true">
            <div id="overlaycontainer">
              <div id="helpoverlay" class="help-box">
                <div id="close-help-overlay" class="tinavg-med-icon"><iron-icon id="close-help-overlay-icon" class="tinavg-med-icon" icon="cancel" on-tap="showHelp"></iron-icon></div>
                <center><h2>This Is Not A Vocabulary Game</h2></center>
                <h3>The Goal</h3>
                <p>Learn the alphabet (shapes and sounds) and spelling patterns of a foreign language.</p>
                <h3>The Rules: Normal / Earmodus / Learnmodus / Talkmodus</h3>
                <ol>
                  <li>Look at the word at the top of the page.</li>
                  <li>Spell the word by tapping the letters in the grid.</li>
                  <li>Check your answer by tapping the word just below the target word.</li>
                  <li>100 points for a correct answer and -30 for an incorrect answer.</li>
                  <li>Earmodus: The word is hidden and only spoken.  The underline gives hints about the word's grammar.</li>
                  <li>Learnmodus: Skip words and do not lose 30 pts for incorrect answers.</li>
                  <li>Talkmodus: Record your voice and play it.  Then click the emoticon for the next word and 250 pts.</li>
                </ol>
                <h3>The Buttons</h3>
                <ol>
                  <li><div class="tinavg-med-icon"><iron-icon id="help-overlay-menutoggle" icon="menu" class="tinavg-med-icon"></iron-icon></div>: Reveals the options menu</li>
                  <li><div class="tinavg-med-icon"><iron-icon id="help-overlay-a" icon="text-format" class="tinavg-med-icon"></iron-icon></div>: Goes through the letter sequence, then says the word aloud</li>
                  <li><div class="tinavg-med-icon"><iron-icon id="help-overlay-help-show" icon="help" class="tinavg-med-icon"></iron-icon></div>: Shows this help menu.</li>
                  <li><div class="tinavg-med-icon"><lang-flag id="help-overlay-switch-modus" mylang="[[currLang]]" langs="[[languageList]]" class="same-line"></lang-flag></div>: Switches the language.  Does NOT check word.</li>
                  <li><div class="tinavg-med-icon"><iron-icon icon="av:mic" class="tinavg-med-icon"></iron-icon></div>: Record voice in Talkmodus.  Also stops recording.</li>
                  <li><div class="tinavg-med-icon"><iron-icon icon="av:play-circle-filled" class="tinavg-med-icon"></iron-icon></div>: Play voice recording.  Also stops recording.</li>
                  <li>Target Word: You can click this to have the word spoken outloud.</li>
                </ol>
                <div id="help-lang-specific"></div>
              </div>
            </div>
          </simple-overlay>
        </div>
        <paper-toast id="übersetzung" text="{{currLang}}"></paper-toast>
      </paper-header-panel>
    </paper-drawer-panel>
  </template>
</dom-module>
<script>
  Polymer({
    is: 'tinavg-webapp',
    properties: {
      currLang: {
        type: String,
        notify: true
      },
      letterLimit: {
        type: Number,
        value: 12
      },
      jumbotronIndex: {
        type: Number,
        value: 13
      },
      learnmodus: {
        type: Boolean
      },
      recordmodus: {
        type: Boolean
      },
      nerdmodus: {
        type: Boolean
      },
      earmodus: {
        type: Boolean
      },
      nerdSprache: {
        type: String
      },
      langHelp: {
        type: String,
        value: ""
      },
      flagIcon: {
        type: String,
        computed: 'flagIconString(currLang)'
      },
      languageList: {
        type: Array,
        value: function() { return ['de', 'en', 'en-US-south', 'ar','ko', 'ru', 'he']; }
      }
    },
    listeners: {
      'letter-card-tapped': 'letterTapped',
      'stripdia-set': 'setWBoardDisplay',
      'lang-help': 'setLangHelp',
      'ready-set-go': 'showÜbersetzung'
    },
    created: function() {

      if(localStorage.getItem("tinavg-earmodus") === undefined) {
        this.earmodus = JSON.parse(localStorage.getItem("tinavg-earmodus"));
      }

      if(localStorage.getItem("tinavg-learnmodus") === undefined) {
        this.learnmodus = JSON.parse(localStorage.getItem("tinavg-learnmodus"));
      }

      if(localStorage.getItem("tinavg-recordmodus") === undefined) {
        this.recordmodus = JSON.parse(localStorage.getItem("tinavg-recordmodus"));
      }

      if(JSON.parse(localStorage.getItem("tinavg-nerdmodus")) === undefined) {
        this.nerdmodus = JSON.parse(localStorage.getItem("tinavg-nerdmodus"));
      }

      if(JSON.parse(localStorage.getItem("tinavg-nerdsprache")) === undefined) {
        this.nerdmodus = JSON.parse(localStorage.getItem("tinavg-nerdsprache"));
      }
    },
    ready: function() {

      // localStorage functions and setting defaults
      window.localStorage["tinavg-lastvisit"] = new Date();
      if(this.languageList.indexOf(JSON.parse(localStorage.getItem("tinavg-lastlang"))) === -1) {
        this.currLang = "de";
      } else {
        this.currLang = JSON.parse(localStorage.getItem("tinavg-lastlang"));
      }
      if(this.earmodus === undefined) this.earmodus = false;
      if(this.learnmodus === undefined) this.learnmodus = false;
      if(this.recordmodus === undefined) this.recordmodus = false;
      if(this.nerdmodus === undefined) this.nerdmodus = false;
      if(this.nerdSprache === undefined) this.nerdSprache = "de";
      this.$.jt.forceLearnmodus(this.learnmodus);

      // Keyboard Shortcut Bindings
      Mousetrap.bind('shift+enter', function() { 
        this.$.jt.click(); 
      }.bind(this));
      Mousetrap.bind('enter', function() {
        document.activeElement.click();
        if(typeof document.activeElement.firePaperRipple === 'function') document.activeElement.firePaperRipple(false);
      });
      Mousetrap.bind('shift+p', function() {
        this.$.wboard.tapWord(false);
      }.bind(this));
      Mousetrap.bind('shift+l', function() {
        this.$.switchModusIcon.click();
      }.bind(this));
      Mousetrap.bind('left', function() {
        var lastTab = this.lastTabIndex;
        this.lastTabIndex = document.activeElement.tabIndex;
        var prevIndex = (document.activeElement.tabIndex === -1) ? this.letterLimit : (document.activeElement.tabIndex - 1 > 0) ? document.activeElement.tabIndex - 1 : this.letterLimit;
        document.querySelector('[tabindex="'+ (prevIndex) + '"]').focus();
      }.bind(this));
      Mousetrap.bind('right', function() {
        var lastTab = this.lastTabIndex;
        this.lastTabIndex = document.activeElement.tabIndex;
        var nextIndex = (document.activeElement.tabIndex === -1 || document.activeElement.tabIndex + 1 > this.letterLimit) ? 1 : document.activeElement.tabIndex + 1;
        document.querySelector('[tabindex="'+ (nextIndex) + '"]').focus();
      }.bind(this));
      Mousetrap.bind('up', function() {
        var lastTab = this.lastTabIndex;
        this.lastTabIndex = document.activeElement.tabIndex;
        var moveFocus = (window.innerHeight > window.innerWidth) ? 3 : 4;
        var prevIndex = (document.activeElement.tabIndex === -1) ? 1 : (document.activeElement.tabIndex - moveFocus > 0) ? document.activeElement.tabIndex - moveFocus : this.jumbotronIndex;
        document.querySelector('[tabindex="'+ (prevIndex) + '"]').focus();
      }.bind(this));
      Mousetrap.bind('down', function() {
        var lastTab = this.lastTabIndex;
        this.lastTabIndex = document.activeElement.tabIndex;
        var moveFocus = (window.innerHeight > window.innerWidth) ? 3 : 4;
        var newFocus = (document.activeElement.tabIndex + moveFocus < this.jumbotronIndex) ? document.activeElement.tabIndex + moveFocus : (document.activeElement.tabIndex === this.jumbotronIndex) ? lastTab : document.activeElement.tabIndex;
        var downIndex = (document.activeElement.tabIndex === -1) ? 1 : newFocus;
        document.querySelector('[tabindex="'+ (downIndex) + '"]').focus();
      }.bind(this));
      Mousetrap.bind('backspace', function(e) {
        // stub to play a wawa sound
        if (e.preventDefault) {
          e.preventDefault();
        } else {
          // internet explorer
          e.returnValue = false;
        }
        console.log("backspace...");
      });
      
      // remove unresolve and reveal app
      document.getElementById('friendly_message').setAttribute('hidden', true);
      document.querySelector('[unresolved]').removeAttribute("unresolved");
      
      //preload flags
      for(var i = 0; i < this.languageList.length; i++) {
        new Image().src = "/assets/images/" + this.languageList[i] + ".png";
      }
      
    },
    setLangHelp: function(e) {
      var langHtml  = e.detail.langHtml;
      if(langHtml) {
        document.getElementById("help-lang-specific").innerHTML = langHtml;
      } else {
        document.getElementById("help-lang-specific").innerHTML = "";
      }
      //this.langHelp = e.detail.langHtml;
    },
    letterTapped: function(e) {
      this.$.jt.lastBucket = e.detail.letter;
    },
    showHelp: function(e) {
      this.$.so.opened = !this.$.so.opened;
    },
    showClue: function(e) {
      this.$.wboard.revealWord();
      if(this.$.clueshow.classList.contains("glow-yellow")) this.$.clueshow.classList.remove("glow-yellow");
      if(this.$.clueshow.style.transform === "rotateX(360deg)") {
        this.$.clueshow.style.transform = "rotateX(0deg)";
      } else {
        this.$.clueshow.style.transform = "rotateX(360deg)";
      }
    },
    toggleEarModus: function() {
      this.earmodus = !this.earmodus;
    },
    toggleLearnModus: function() {
      this.learnmodus = !this.learnmodus;
      this.$.jt.resetBox();
    },
    toggleRecordModus: function() {
      this.recordmodus = !this.recordmodus;
      this.learnmodus = this.recordmodus;
      this.$.select_learnmodus.toggleAttribute('disabled');
      this.$.jt.resetBox();
    },
    refreshBuggyFill: function() {
      window.viewportUnitsBuggyfill.init({force: true});
      window.viewportUnitsBuggyfill.refresh();
      window.viewportUnitsBuggyfill.findProperties();
      console.log(window.viewportUnitsBuggyfill.getCss());
    },
    setLang: function(ev) {
      console.log("toggling language: " + ev.target.value + " | chars: " + this.letterLimit);
      this.currLang = ev.target.value;
      this.$.jt.resetBox();
    },
    setLangManual: function(lang) {
      console.log("toggling language: " + lang + " | chars: " + this.letterLimit);
      this.currLang = lang;
      this.$.jt.resetBox();
    },
    setLang2: function(ev) {
      console.log(ev);
      console.log("toggling language: " + ev.target.value + " | chars: " + this.letterLimit);
      this.currLang = ev.detail.item.lang;
      this.$.jt.resetBox();
    },
    setWBoardDisplay: function(ev) {
      console.log("changing diacritics");
      this.$.wboard.setDisplayWord();
    },
    switchModus: function(newLang) {
      if(this.languageList.indexOf(newLang) !== -1) {
        this.currLang = newLang;
      } else {
        var nextLangInd = (this.languageList.indexOf(this.currLang) === -1 || this.languageList.indexOf(this.currLang) + 1 >= this.languageList.length) ? 0 : this.languageList.indexOf(this.currLang) + 1;
        this.currLang = this.languageList[nextLangInd];
      }
      this.$.jt.resetBox();
    },
    flagIconString: function(lang) {
      return "country-flags:" + lang;
    },
    toggleNerdModus: function() {
      this.nerdmodus = !this.nerdmodus;
      this.showÜbersetzung();
    },
    showÜbersetzung: function() {
      // stub to add phrase info
      if(this.nerdmodus) {
        if(this.$.wboard.getWordObj().übersetzung !== undefined && this.$.wboard.getWordObj().übersetzung[this.nerdSprache]) {
          this.$.übersetzung.text = this.$.wboard.getWordObj().übersetzung[this.nerdSprache];
        } else if(this.$.wboard.getWordObj().uebersetzungen[this.nerdSprache] !== undefined) {
          this.$.übersetzung.text = this.$.wboard.getWordObj().uebersetzungen[this.nerdSprache];
        } else {
          this.$.übersetzung.text = "Es tut mir Leid.  Keine Übersetzung :-(";
        }
        this.$.übersetzung.show();
      }
    },
    setNerdSprache: function(ev) {
      this.nerdSprache = ev.target.value;
      this.showÜbersetzung();
    }
  });

</script>