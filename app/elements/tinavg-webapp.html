<link rel="import" href="../../bower_components/polymer/polymer.html">
<!-- Additional Component Load -->
<!-- Layout/Polymer Elements -->
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">

<!-- Custom Elements Vulcanized -->
<link rel="import" href="country-flags.html">
<link rel="import" href="elements.html">
<!-- keyboard shortcuts -->
<script src="../assets/js/mousetrap.min.js"></script>

<dom-module id="tinavg-webapp">
  <style>
  </style>
  <template>
    <paper-header-panel id="header-panel">
      <div class="two-headers">
        <div class="footer horizontal justified layout center">
          <div class="footer-button horizontal start-justified layout flex">
            <score-board id="score-board-player-1" player="1" learnmodus="{{learnmodus}}" recordmodus="{{recordmodus}}"></score-board>
          </div>
          <word-board id="wboard" class="horizontal center-justified layout flex-2" lang-code="{{currLang}}"></word-board>
          <div class="horizontal end-justified layout flex">
            <iron-icon id="menutoggle" class="spin-flip-transition tinavg-med-icon" icon="trending-neutral" on-tap="toggleCoreCollapse"></iron-icon>
          </div>
        </div>
        <div class="core-header horizontal justified layout center">
          <div class="top-right-item horizontal start-justified layout flex">
            <iron-icon id="help-show" class="tinavg-med-icon" icon="help" on-tap="showHelp"></iron-icon>
            <lang-flag id="switchModusIcon" mylang="[[currLang]]" langs="[[languageList]]" on-tap="switchModus"></lang-flag>
          </div>
          <div class="horizontal center-justified layout flex-2">
            <jumbotron-text id="jt" tabindex="{{jumbotronIndex}}" learnmodus="{{learnmodus}}"></jumbotron-text>
          </div>
          <div id="nerdmodus-div" class="horizontal end-justified layout flex">
            <score-board id="score-board-player-2" player="2" hidden></score-board>
            <div id="clue-show-div"><iron-icon id="clueshow" class="spin-flip-transition tinavg-med-icon" icon="text-format" on-tap="showClue"></iron-icon></div>
          </div>
        </div>
      </div>
      <div class="content">
        <section id="overlaycontainer">
          <div id="helpoverlay" class="help-box">
            <div id="close-help-overlay"><iron-icon id="close-help-overlay-icon" class="tinavg-med-icon" icon="cancel" on-tap="showHelp"></iron-icon></div>
            <center><h2>This Is Not A Vocabulary Game</h2></center>
            <h3>The Goal</h3>
            <p>Learn the alphabet (shapes and sounds) and spelling patterns of a foreign language.</p>
            <h3>The Rules: Normal / Earmodus / Learnmodus / Talkmodus</h3>
            <ol>
              <li>Look at the word at the top of the page.</li>
              <li>Spell the word by tapping the letters in the grid.</li>
              <li>Check your answer by tapping the word just below the target word.</li>
              <li>100 points for a correct answer and -30 for an incorrect answer.</li>
              <li>Earmodus: The word is hidden and only spoken.  The underline gives hints about the word's grammar.</li>
              <li>Learnmodus: Skip words and do not lose 30 pts for incorrect answers.</li>
              <li>Talkmodus: Record your voice and play it.  Then click the emoticon for the next word and 250 pts.</li>
            </ol>
            <h3>The Buttons</h3>
            <ol>
              <li><iron-icon id="help-overlay-menutoggle" icon="trending-neutral" class="tinavg-med-icon"></iron-icon>: Reveals the options menu</li>
              <li><iron-icon id="help-overlay-a" icon="text-format" class="tinavg-med-icon"></iron-icon>: Goes through the letter sequence, then says the word aloud</li>
              <li><iron-icon id="help-overlay-help-show" icon="help" class="tinavg-med-icon"></iron-icon>: Shows this help menu.</li>
              <li><iron-icon id="help-overlay-switchModusIcon" icon="country-flags:de" class="tinavg-med-icon"></iron-icon>: Switches the language.  Does NOT check word.</li>
              <li><iron-icon icon="av:mic" class="tinavg-med-icon"></iron-icon>: Record voice in Talkmodus.  Also stops recording.</li>
              <li><iron-icon icon="av:play-circle-fill" class="tinavg-med-icon"></iron-icon>: Play voice recording.  Also stops recording.</li>
              <li>Target Word: You can click this to have the word spoken outloud.</li>
            </ol>
            <div id="help-lang-specific"></div>
          </div>
        </section>
        <div class="horizontal layout">
          <iron-collapse id="collapse" horizontal>
            <div class="mini-menu">
              <div>
                Language: 
                <select on-change="setLang">
                  <option value="de">German</option>
                  <option value="en">English</option>
                  <option value="en-US-south">English (US South)</option>
                  <option value="ar">Arabic</option>
                  <option value="ko">Korean</option>
                  <option value="ru">Russian</option>
                  <!--
                  <option value="tr">Turkish</option>
                  -->
                </select>
              </div>
              <div><br />Earmodus: <paper-toggle-button id="select_earmodus" on-tap="toggleEarModus"></paper-toggle-button></div>
              <div><br />Learnmodus: <paper-toggle-button id="select-learnmodus" on-tap="toggleLearnModus"></paper-toggle-button></div>
              <div><br />Talkmodus: <paper-toggle-button id="select-recordmodus" on-tap="toggleRecordModus"></paper-toggle-button></div>
              <div><br />BuggyFill: <paper-toggle-button id="select-buggyfill" on-tap="refreshBuggyFill"></paper-toggle-button></div>
              <div hidden><br />Nerdmodus: <button id="select-nerdmodus" on-tap="toggleNerdModus">toggle</button></div>
            </div>
          </iron-collapse>
          <div id="maincontentarea"><word-recorder id="wrecorder" hidden></word-recorder><letter-list id="lettergrid" limit="{{letterLimit}}" lang-code="{{currLang}}"></letter-list></div>
        </div>
      </div>
    </paper-header-panel>
  </template>
</dom-module>
<script>
  Polymer({
    is: 'tinavg-webapp',
    properties: {
      currLang: {
        type: String,
        value: "de",
        notify: true
      },
      letterLimit: {
        type: Number,
        value: 12
      },
      jumbotronIndex: {
        type: Number,
        value: 13
      },
      learnmodus: {
        type: Boolean,
        value: false
      },
      recordmodus: {
        type: Boolean,
        value: false
      },
      langHelp: {
        type: String,
        value: ""
      },
      flagIcon: {
        type: String,
        computed: 'flagIconString(currLang)'
      },
      languageList: {
        type: Array,
        value: function() { return ['de', 'en', 'en-US-south', 'ar',"ko", "ru"]; }
      }
    },
    listeners: {
      'letter-card-tapped': 'letterTapped',
      'stripdia-set': 'setWBoardDisplay',
      'lang-help': 'setLangHelp'
    },
    ready: function() {
      Mousetrap.bind('shift+enter', function() { 
        this.$.jt.click(); 
      }.bind(this));
      Mousetrap.bind('enter', function() {
        document.activeElement.click();
        if(typeof document.activeElement.firePaperRipple === 'function') document.activeElement.firePaperRipple(false);
      });
      Mousetrap.bind('shift+p', function() {
        this.$.wboard.tapWord(false);
      }.bind(this));
      Mousetrap.bind('shift+l', function() {
        this.$.switchModusIcon.click();
      }.bind(this));
      Mousetrap.bind('left', function() {
        var lastTab = this.lastTabIndex;
        this.lastTabIndex = document.activeElement.tabIndex;
        var prevIndex = (document.activeElement.tabIndex === -1) ? this.letterLimit : (document.activeElement.tabIndex - 1 > 0) ? document.activeElement.tabIndex - 1 : this.letterLimit;
        document.querySelector('[tabindex="'+ (prevIndex) + '"]').focus();
      }.bind(this));
      Mousetrap.bind('right', function() {
        var lastTab = this.lastTabIndex;
        this.lastTabIndex = document.activeElement.tabIndex;
        var nextIndex = (document.activeElement.tabIndex === -1 || document.activeElement.tabIndex + 1 > this.letterLimit) ? 1 : document.activeElement.tabIndex + 1;
        document.querySelector('[tabindex="'+ (nextIndex) + '"]').focus();
      }.bind(this));
      Mousetrap.bind('up', function() {
        var lastTab = this.lastTabIndex;
        this.lastTabIndex = document.activeElement.tabIndex;
        var moveFocus = (window.innerHeight > window.innerWidth) ? 3 : 4;
        var prevIndex = (document.activeElement.tabIndex === -1) ? 1 : (document.activeElement.tabIndex - moveFocus > 0) ? document.activeElement.tabIndex - moveFocus : this.jumbotronIndex;
        document.querySelector('[tabindex="'+ (prevIndex) + '"]').focus();
      }.bind(this));
      Mousetrap.bind('down', function() {
        var lastTab = this.lastTabIndex;
        this.lastTabIndex = document.activeElement.tabIndex;
        var moveFocus = (window.innerHeight > window.innerWidth) ? 3 : 4;
        var newFocus = (document.activeElement.tabIndex + moveFocus < this.jumbotronIndex) ? document.activeElement.tabIndex + moveFocus : (document.activeElement.tabIndex === this.jumbotronIndex) ? lastTab : document.activeElement.tabIndex;
        var downIndex = (document.activeElement.tabIndex === -1) ? 1 : newFocus;
        document.querySelector('[tabindex="'+ (downIndex) + '"]').focus();
      }.bind(this));
      Mousetrap.bind('backspace', function(e) {
        // stub to play a wawa sound
        if (e.preventDefault) {
          e.preventDefault();
        } else {
          // internet explorer
          e.returnValue = false;
        }
        console.log("backspace...");
      });
      document.getElementById('friendly_message').setAttribute('hidden', true);
      document.querySelector('[unresolved]').removeAttribute("unresolved");
      //preload flags
      for(var i = 0; i < this.languageList.length; i++) {
        new Image().src = "/assets/images/" + this.languageList[i] + ".png";
      }
      /*
      var fixIcons = document.querySelectorAll(".iron-icon-0");
      for(var i = 0; i < fixIcons.length; i++) {
        fixIcons[i].classList.remove("iron-icon-0");
        if(fixIcons[i].classList.contains("tinavg-med-icon")) {
          fixIcons[i].style.height = "7vh";
          fixIcons[i].style.width = "7vh";
        }
        if(fixIcons[i].classList.contains("recorder-icon")) {
          fixIcons[i].style.height = "25vw";
          fixIcons[i].style.width = "25vw";
        }
        //fixIcons[i].classList.add("iron-icon-0");
      }
      */

    },
    setLangHelp: function(e) {
      var langHtml  = e.detail.langHtml;
      if(langHtml) {
        document.getElementById("help-lang-specific").innerHTML = langHtml;
      } else {
        document.getElementById("help-lang-specific").innerHTML = "";
      }
      //this.langHelp = e.detail.langHtml;
    },
    letterTapped: function(e) {
      this.$.jt.lastBucket = e.detail.letter;
    },
    showHelp: function(e) {
      this.$.helpoverlay.hidden = !this.$.helpoverlay.hidden;
    },
    showClue: function(e) {
      this.$.wboard.revealWord();
      if(this.$.clueshow.classList.contains("glow-yellow")) this.$.clueshow.classList.remove("glow-yellow");
      if(this.$.clueshow.style.transform === "rotateX(360deg)") {
        this.$.clueshow.style.transform = "rotateX(0deg)";
      } else {
        this.$.clueshow.style.transform = "rotateX(360deg)";
      }
    },
    toggleCoreCollapse: function(e) {
      this.$.collapse.toggle();
      if(this.$.collapse.opened) {
        this.$.menutoggle.style.transform = "rotateY(180deg)";
      } else {
        this.$.menutoggle.style.transform = "rotateY(0deg)";
      }
    },
    toggleEarModus: function() {
      this.$.wboard.hideWord();
    },
    toggleLearnModus: function() {
      this.learnmodus = !this.learnmodus;
      this.$.jt.resetBox();
    },
    toggleRecordModus: function() {
      this.recordmodus = !this.recordmodus;
      this.$.wrecorder.hidden = !this.$.wrecorder.hidden;
      this.$.lettergrid.hidden = !this.$.lettergrid.hidden;
      this.learnmodus = this.recordmodus;
      this.$.jt.resetBox();
    },
    refreshBuggyFill: function() {
      window.viewportUnitsBuggyfill.init({force: true});
      window.viewportUnitsBuggyfill.refresh();
      window.viewportUnitsBuggyfill.findProperties();
      console.log(window.viewportUnitsBuggyfill.getCss());
    },
    setLang: function(ev) {
      console.log("toggling language: " + ev.target.value + " | chars: " + this.letterLimit);
      this.currLang = ev.target.value;
      this.$.jt.resetBox();
    },
    setLangManual: function(lang) {
      console.log("toggling language: " + lang + " | chars: " + this.letterLimit);
      this.currLang = lang;
      this.$.jt.resetBox();
    },
    setLang2: function(ev) {
      console.log(ev);
      console.log("toggling language: " + ev.target.value + " | chars: " + this.letterLimit);
      this.currLang = ev.detail.item.lang;
      this.$.jt.resetBox();
    },
    setWBoardDisplay: function(ev) {
      console.log("changing diacritics");
      this.$.wboard.setDisplayWord();
    },
    switchModus: function(newLang) {
      if(this.languageList.indexOf(newLang) !== -1) {
        this.currLang = newLang;
      } else {
        var nextLangInd = (this.languageList.indexOf(this.currLang) === -1 || this.languageList.indexOf(this.currLang) + 1 >= this.languageList.length) ? 0 : this.languageList.indexOf(this.currLang) + 1;
        console.log(nextLangInd);
        this.currLang = this.languageList[nextLangInd];
      }
    },
    flagIconString: function(lang) {
      return "country-flags:" + lang;
    }
  });

</script>