<link rel="import" href="../../bower_components/polymer/polymer.html">
<!-- Additional Component Load -->
<!-- Layout/Polymer Elements -->
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<!-- Custom Elements Vulcanized -->
<link rel="import" href="elements.html">
<!-- keyboard shortcuts -->
<script src="../assets/js/mousetrap.min.js"></script>

<dom-module id="tinavg-webapp">
  <style>
  </style>
  <template>
    <paper-header-panel id="header-panel">
      <div class="core-header horizontal justified layout center">
        <score-board id="score-board-player-1" player="1" class="horizontal start-justified layout flex" learnmodus="{{learnmodus}}" recordmodus="{{recordmodus}}"></score-board>
        <word-board id="wboard" class="horizontal center-justified layout flex-2" lang-code="{{currLang}}"></word-board>
        <div class="top-right-item horizontal end-justified layout flex">
          <score-board id="score-board-player-2" player="2" hidden></score-board>
        </div>
      </div>
      <div class="content">
        <section id="overlaycontainer">
          <div id="helpoverlay" class="help-box" hidden>
            <div id="close-help-overlay"><iron-icon id="close-help-overlay-icon" icon="cancel" on-tap="showHelp"></iron-icon></div>
            <center><h1>This Is Not A Vocabulary Game</h1></center>
            <h3>The Goal</h3>
            <p>Learn the alphabet (shapes and sounds) and spelling patterns of a foreign language.</p>
            <h3>The Rules</h3>
            <ol>
              <li>Look at the word at the top of the page.</li>
              <li>Spell the word by tapping the letters in the grid.</li>
              <li>Check your answer by tapping the word at the bottom of the page.</li>
            </ol>
            <h3>Scoring and Tips</h3>
            <ol>
              <li>100 points for each correct answer and -30 points for each wrong answer.</li>
              <li>If you need help, click the <iron-icon id="help-overlay-a" icon="text-format"></iron-icon> button in the bottom right corner.</li>
              <li>When you spell the word correctly, you will automatically hear the word.</li>
              <li>However, you still must click the word at the bottom to check it.</li>
              <li>There is no delete button, so be careful!</li>
            </ol>
            <div id="help-lang-specific"></div>
          </div>
        </section>
        <div class="horizontal layout">
          <iron-collapse id="collapse" horizontal>
            <div class="mini-menu">
              <div>
                Language: 
                <select on-change="setLang">
                  <option value="de">German</option>
                  <option value="en">English</option>
                  <option value="en-US-south">English (US South)</option>
                  <option value="ar">Arabic</option>
                  <!--
                  <option value="tr">Turkish</option>
                  -->
                </select>
              </div>
              <div><br />Earmodus: <button id="select-earmodus" on-tap="toggleEarModus">toggle</button></div>
              <div><br />Learnmodus: <button id="select-learnmodus" on-tap="toggleLearnModus">toggle</button></div>
              <div><br />Recordmodus: <button id="select-recordmodus" on-tap="toggleRecordModus">toggle</button></div>
              <div><br />BuggyFill: <button id="select-buggyfill" on-tap="refreshBuggyFill">toggle</button></div>
              <div hidden><br />Nerdmodus: <button id="select-nerdmodus" on-tap="toggleNerdModus">toggle</button></div>
            </div>
          </iron-collapse>
          <div id="maincontentarea"><word-recorder id="wrecorder" hidden></word-recorder><letter-list id="lettergrid" limit="{{letterLimit}}" lang-code="{{currLang}}"></letter-list></div>
        </div>
        <div class="footer horizontal justified layout center">
          <div class="footer-button horizontal start-justified layout flex">
            <iron-icon id="menutoggle" class="spin-flip-transition" icon="trending-neutral" on-tap="toggleCoreCollapse"></iron-icon>
          </div>
          <jumbotron-text id="jt" tabindex="{{jumbotronIndex}}" class="horizontal center-justified layout flex-2" learnmodus="{{learnmodus}}"></jumbotron-text>
          <div id="nerdmodus-div" class="horizontal end-justified layout flex">
            <div id="clue-show-div"><iron-icon id="clueshow" class="spin-flip-transition" icon="text-format" on-tap="showClue"></iron-icon></div>
            <iron-icon id="help-show" icon="help" on-tap="showHelp"></iron-icon>
          </div>
        </div>
      </div>
    </paper-header-panel>
  </template>
</dom-module>
<script>
  Polymer({
    is: 'tinavg-webapp',
    properties: {
      currLang: {
        type: String,
        value: "de",
        notify: true
      },
      letterLimit: {
        type: Number,
        value: 12
      },
      jumbotronIndex: {
        type: Number,
        value: 13
      },
      learnmodus: {
        type: Boolean,
        value: false
      },
      recordmodus: {
        type: Boolean,
        value: false
      },
      langHelp: {
        type: String,
        value: ""
      }
    },
    listeners: {
      'letter-card-tapped': 'letterTapped',
      'stripdia-set': 'setWBoardDisplay',
      'lang-help': 'setLangHelp'
    },
    ready: function() {
      Mousetrap.bind('shift+enter', function() { 
        this.$.jt.click(); 
      }.bind(this));
      Mousetrap.bind('enter', function() {
        document.activeElement.click();
        if(typeof document.activeElement.firePaperRipple === 'function') document.activeElement.firePaperRipple(false);
      });
      Mousetrap.bind('a', function() {
        console.log(window.innerHeight > window.innerWidth);
      });
      Mousetrap.bind('p', function() {
        this.$.wboard.tapWord(false);
        console.log(window.innerHeight > window.innerWidth);
      }.bind(this));
      Mousetrap.bind('left', function() {
        var prevIndex = (document.activeElement.tabIndex === -1) ? this.letterLimit : (document.activeElement.tabIndex - 1 > 0) ? document.activeElement.tabIndex - 1 : this.letterLimit;
        document.querySelector('[tabindex="'+ (prevIndex) + '"]').focus();
      }.bind(this));
      Mousetrap.bind('right', function() {
        var nextIndex = (document.activeElement.tabIndex === -1 || document.activeElement.tabIndex + 1 > this.letterLimit) ? 1 : document.activeElement.tabIndex + 1;
        document.querySelector('[tabindex="'+ (nextIndex) + '"]').focus();
      }.bind(this));
      Mousetrap.bind('up', function() {
        var moveFocus = (window.innerHeight > window.innerWidth) ? 3 : 4;
        var prevIndex = (document.activeElement.tabIndex === -1) ? this.jumbotronIndex : (document.activeElement.tabIndex - moveFocus > 0) ? document.activeElement.tabIndex - moveFocus : (moveFocus === 4) ? document.activeElement.tabIndex + moveFocus * 2 : document.activeElement.tabIndex + moveFocus * 3;
        document.querySelector('[tabindex="'+ (prevIndex) + '"]').focus();
      }.bind(this));
      Mousetrap.bind('down', function() {
        var moveFocus = (window.innerHeight > window.innerWidth) ? 3 : 4;
        var newFocus = (document.activeElement.tabIndex + moveFocus < this.jumbotronIndex) ? document.activeElement.tabIndex + moveFocus : this.jumbotronIndex;
        var downIndex = (document.activeElement.tabIndex === -1) ? 1 : newFocus;
        document.querySelector('[tabindex="'+ (downIndex) + '"]').focus();
      }.bind(this));
      Mousetrap.bind('backspace', function(e) {
        // stub to play a wawa sound
        if (e.preventDefault) {
          e.preventDefault();
        } else {
          // internet explorer
          e.returnValue = false;
        }
        console.log("backspace...");
      });      
    },
    setLangHelp: function(e) {
      var langHtml  = e.detail.langHtml;
      if(langHtml) {
        document.getElementById("help-lang-specific").innerHTML = langHtml;
      } else {
        document.getElementById("help-lang-specific").innerHTML = "";
      }
      //this.langHelp = e.detail.langHtml;
    },
    letterTapped: function(e) {
      this.$.jt.lastBucket = e.detail.letter;
    },
    showHelp: function(e) {
      this.$.helpoverlay.hidden = !this.$.helpoverlay.hidden;
    },
    showClue: function(e) {
      this.$.wboard.revealWord();
      if(this.$.clueshow.classList.contains("glow-yellow")) this.$.clueshow.classList.remove("glow-yellow");
      if(this.$.clueshow.style.transform === "rotateX(360deg)") {
        this.$.clueshow.style.transform = "rotateX(0deg)";
      } else {
        this.$.clueshow.style.transform = "rotateX(360deg)";
      }
    },
    toggleCoreCollapse: function(e) {
      this.$.collapse.toggle();
      if(this.$.collapse.opened) {
        this.$.menutoggle.style.transform = "rotateY(180deg)";
      } else {
        this.$.menutoggle.style.transform = "rotateY(0deg)";
      }
    },
    toggleEarModus: function() {
      this.$.wboard.hideWord();
    },
    toggleLearnModus: function() {
      this.learnmodus = !this.learnmodus;
      this.$.jt.resetBox();
    },
    toggleRecordModus: function() {
      this.recordmodus = !this.recordmodus;
      this.$.wrecorder.hidden = !this.$.wrecorder.hidden;
      this.$.lettergrid.hidden = !this.$.lettergrid.hidden;
      this.learnmodus = true;
      this.$.jt.resetBox();
    },
    refreshBuggyFill: function() {
      window.viewportUnitsBuggyfill.init({force: true});
      window.viewportUnitsBuggyfill.refresh();
      window.viewportUnitsBuggyfill.findProperties();
      console.log(window.viewportUnitsBuggyfill.getCss());
    },
    setLang: function(ev) {
      console.log("toggling language: " + ev.target.value + " | chars: " + this.letterLimit);
      this.currLang = ev.target.value;
      this.$.jt.resetBox();
    },
    setWBoardDisplay: function(ev) {
      console.log("changing diacritics");
      this.$.wboard.setDisplayWord();
    }
  });


</script>