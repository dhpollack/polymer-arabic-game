<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../services/word-service.html">

<dom-module id="word-board">
  <style>
  </style>
  <template>
    <div id="word-board-word" class="word-board"><span id="my-word">{{myWord}}</span></div>
    <audio src="{{wordAudio}}" hidden></audio>
    <word-service id="wservice" currlang="{{langCode}}" warray="{{warray}}"></word-service>
  </template>
</dom-module>
<script>
(function() {

  Polymer({
    is: "word-board",
    properties: {
      langCode: {
        type: String,
        notify: true
      },
      wordAudio: {
        type: String
      },
      myWord: {
        type: String,
        value: "",
        notify: true
      },
      wordArray: {
        type: Array,
        notify: true,
        value: function() { return []; }
      },
      ranWordIndex: {
        type: Number
      },
      phraseArray: {
        type: Array,
        value: function() { return []; }
      },
      phraseIndex: {
        type: Number,
        value: 0
      }
    },
    listeners: {
      'new-words': 'setWords',
      'lang-code-changed': 'changeLanguage',
      'word-array-changed': 'wordFilter',
      'tap': 'tapWord'
    },
    created: function() {
    },
    init: function() {
      this.jumbotronBox = document.querySelector("jumbotron-text");
      this.scoreBox = document.getElementById('score-board-player-1');
      this.letterListBox = document.querySelector('letter-list');
      
      this.wordBoardWord = document.getElementById("word-board-word");
      this.myWordSpan = document.getElementById("my-word");
      var wordSpan = this.wordBoardWord;
      this.audioBox = Polymer.dom(this.root).querySelector("audio");
      this.audioBox.onended = function() { 
          wordSpan.classList.remove("flip-text");
        };
    },
    changeLanguage: function(event) {
      this.$.wservice.currlang = this.langCode;
      this.phraseArray = [];
      this.phraseIndex = 0;
    },
    wordFilter: function() {
      if(!this.letterListBox) this.init();
      var randomIndex = Math.floor(Math.random() * this.wordArray.length);
      this.phraseIndex++;
      if(this.wordArray.length !== 0) {
        if(this.phraseArray[this.phraseIndex] === undefined) {
          if(this.ranWordIndex !== undefined) {
            for(var i=0;this.ranWordIndex === randomIndex;i++) {
              randomIndex = Math.floor(Math.random() * this.wordArray.length);
              if(i > 20) break;
            }
          }
          this.ranWordIndex = randomIndex;
          console.log("wordArray.length: " + this.wordArray.length + "\nthis.ranWordIndex: " + this.ranWordIndex);
          
          //word = this.wordArray[this.ranWordIndex];
          var findex = (this.letterListBox.stripDiacritics) ? 1 : 0;
          this.phraseArray = this.wordArray[this.ranWordIndex][findex].split(" ");
          this.phraseIndex = 0;
        }
        if(this.wordArray[this.ranWordIndex][2] !== (undefined || null) && typeof this.wordArray[this.ranWordIndex][2] === 'object') {
          this.wordBoardWord.className = "";
          if(this.wordArray[this.ranWordIndex][2].grammar.segments === undefined) {
            this.setGrammarStyles(this.wordArray[this.ranWordIndex][2].grammar);
          } else {
            this.setGrammarStyles(this.wordArray[this.ranWordIndex][2].grammar.segments[this.phraseIndex]);
          }
        }
        this.myWord = this.phraseArray[this.phraseIndex];
        
        this.wordAudio = this.produceWordAudioUrl(this.phraseArray[this.phraseIndex].toLowerCase(), this.langCode);
        this.letterListBox.setWord = true;
        this.letterListBox.runLetters();

        this.jumbotronBox.zielWort = this.phraseArray[this.phraseIndex];
        
        if(this.myWordSpan.classList.contains('invisible-text')) this.audioBox.play();
      }
    },
    getCheckWord: function() {
      if(this.wordArray.length !== 0) {
        var findex = (this.letterListBox.stripDiacritics) ? 1 : 0;
        var word = this.wordArray[this.ranWordIndex][findex].split(" ");
        return word[this.phraseIndex];
      } else {
        console.log("words not set yet");
        return;
      }
    },
    setWords: function() {
      if(!this.wordBoardWord) this.init();
      var items = this.$.wservice.warray;
      if(items.length !== 0) {
        this.wordArray = items;
      }
    },
    revealWord: function() {
      var pauseLength = 1500;
      var findex = (this.letterListBox.stripDiacritics) ? 1 : 0;

      var word = this.wordArray[this.ranWordIndex][findex].toLowerCase();
      word.split("").forEach(function(value, index) {
        setTimeout(function() {
          var lCard = document.querySelector('letter-card[letter="'+value+'"]');
          lCard.firePaperRipple(true);
        }, pauseLength * (index + 0.5));
      });
      setTimeout(function() {
        this.playAudio();
      }.bind(this), pauseLength * (word.length + 0.5));
    },
    hideWord: function() {
      if(!this.myWordSpan.classList.contains('invisible-text')) {
        this.myWordSpan.classList.add('invisible-text');
      } else {
        this.myWordSpan.classList.remove('invisible-text');
      }
    },
    produceWordAudioUrl: function(word, lang) {
      return "/assets/audio/"+ lang +"/words/" + word + ".m4a";
    },
    tapWord: function(tapped) {
      this.wordBoardWord.classList.add("flip-text");
      if(this.audioBox.paused && tapped) this.scoreBox.score++;
      this.playAudio();
    },
    playAudio: function() {
      if(!this.audioBox.paused) {
        this.audioBox.pause();
        this.audioBox.currentTime = this.audioBox.currentTime / 3;
      }
      this.audioBox.play();
    },
    setGrammarStyles: function(grammar) {
      var classesToAdd = [];
      var wordDiv = this.wordBoardWord;
      // this should probably be a map of some sort
      classesToAdd.push("word-board");
      if(grammar.partofs !== undefined) {
        switch(grammar.partofs) {
          case "adjective":
          case "adverb":
            classesToAdd.push("word-board-adj-adv");
            break;
          case "verb":
            classesToAdd.push("word-board-verb");
            break;
          case "noun":
            // doing nothing with nouns, but theoretical could change
            break;
        }
      }
      if(grammar.number) {
        switch(grammar.number) {
          case "plural":
            classesToAdd.push("word-board-plural");
            break;
          case "singular":
            // already in default so nothing.  this is a stub
            break;
        }        
      }
      if(grammar.gender) {
        switch(grammar.gender) {
          case "male":
            classesToAdd.push("word-board-male");
            break;
          case "female":
            classesToAdd.push("word-board-female");
            break;
          case "neuter":
            classesToAdd.push("word-board-neuter");
            break;
        }        
      }
      classesToAdd.forEach(function(value) {
        wordDiv.classList.add(value);
      });
    }
  });
})();
</script>