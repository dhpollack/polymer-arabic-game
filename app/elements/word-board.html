<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../services/word-service.html">

<dom-module id="word-board">
  <style>
  </style>
  <template>
    <div id="word-board-word" class="word-board"><span>{{myWord}}</span></div>
    <audio src="{{wordAudio}}" hidden></audio>
    <word-service id="wservice" currlang="{{langCode}}" warray="{{warray}}"></word-service>
  </template>
</dom-module>
<script>
(function() {

  Polymer({
    is: "word-board",
    properties: {
      langCode: {
        type: String,
        notify: true
      },
      wordAudio: {
        type: String
      },
      myWord: {
        type: String,
        value: "",
        notify: true
      },
      wordArray: {
        type: Array,
        notify: true,
        value: function() { return []; }
      },
      ranWordIndex: {
        type: Number
      }
    },
    listeners: {
      'new-words': 'setWords',
      'lang-code-changed': 'changeLanguage',
      'word-array-changed': 'wordFilter',
      'tap': 'playAudio'
    },
    created: function() {
    },
    ready: function() {
      this.jumbotronBox = document.querySelector("jumbotron-text");
      this.scoreBox = document.getElementById('score-board-player-1');
      this.letterListBox = document.querySelector('letter-list');
      
      this.wordBoardWord = document.getElementById("word-board-word");
      
      this.audioBox = Polymer.dom(this.root).querySelector("audio");
    },
    changeLanguage: function(event) {
      this.$.wservice.currlang = this.langCode;
    },
    wordFilter: function() {
      if(!this.letterListBox) this.letterListBox = document.querySelector('letter-list');
      var randomIndex = Math.floor(Math.random() * this.wordArray.length);
      if(this.wordArray.length !== 0) {
        if(this.ranWordIndex !== undefined) {
          for(var i=0;this.ranWordIndex === randomIndex;i++) {
            randomIndex = Math.floor(Math.random() * this.wordArray.length);
            if(i > 20) break;
          }
        }
        this.ranWordIndex = randomIndex;
        console.log("wordArray.length: " + this.wordArray.length + "\nthis.ranWordIndex: " + this.ranWordIndex);
        var word = this.wordArray[this.ranWordIndex];
        //this.fire("random-word-selected", { value: word[0], valueOhneAccent: word[1], langCode: this.langCode });
        if(word[2] !== (undefined || null) && typeof word[2] === 'object') {
          this.wordBoardWord.className = "";
          this.setGrammarStyles(word[2].grammar);
        }

        this.myWord = word[0];
        this.wordAudio = this.produceWordAudioUrl(word[0].toLowerCase(), this.langCode);
        this.letterListBox.setWord = true;
        this.letterListBox.runLetters();

        this.jumbotronBox.zielWort = word[0];
      }
    },
    getCheckWord: function() {
      var findex = (this.letterListBox.stripDiacritics) ? 1 : 0;
      var word = this.wordArray[this.ranWordIndex];
      return word[findex];
      
    },
    setWords: function() {
      var items = this.$.wservice.warray;
      if(items.length !== 0) {
        this.wordArray = items;
      }
    },
    revealWord: function() {
      var pauseLength = 1500;
      var findex = (this.letterListBox.stripDiacritics) ? 1 : 0;

      var word = this.wordArray[this.ranWordIndex][findex].toLowerCase();
      word.split("").forEach(function(value, index) {
        setTimeout(function() {
          var lCard = document.querySelector('letter-card[letter="'+value+'"]');
          lCard.firePaperRipple(true);
        }, pauseLength * (index + 0.5));
      });
      setTimeout(function() {
        this.playAudio();
      }.bind(this), pauseLength * (word.length + 0.5));
    },
    produceWordAudioUrl: function(word, lang) {
      return "/assets/audio/"+ lang +"/words/" + word + ".m4a";
    },
    playAudio: function() {
      if(!this.audioBox.paused) {
        this.audioBox.pause();
        this.audioBox.currentTime = this.audioBox.currentTime / 3;
      }
      this.audioBox.play();
    },
    setGrammarStyles: function(grammar) {
      var classesToAdd = [];
      // this should probably be a map of some sort
      classesToAdd.push("word-board");
      if(grammar.partofs !== undefined) {
        switch(grammar.partofs) {
          case "adjective":
          case "adverb":
            classesToAdd.push("word-board-adj-adv");
            break;
          case "verb":
            classesToAdd.push("word-board-verb");
            break;
          case "noun":
            // doing nothing with nouns, but theoretical could change
            break;
        }
      }
      if(grammar.number) {
        switch(grammar.number) {
          case "plural":
            classesToAdd.push("word-board-plural");
            break;
          case "singular":
            // already in default so nothing.  this is a stub
            break;
        }        
      }
      if(grammar.gender) {
        switch(grammar.gender) {
          case "male":
            classesToAdd.push("word-board-male");
            break;
          case "female":
            classesToAdd.push("word-board-female");
            break;
          case "neuter":
            classesToAdd.push("word-board-neuter");
            break;
        }        
      }
      for(var i = 0; i < classesToAdd.length; i++) {
        if(i !== 0)  this.wordBoardWord.className += ' ';
        this.wordBoardWord.className += classesToAdd[i];
      }
    }
  });
})();
</script>