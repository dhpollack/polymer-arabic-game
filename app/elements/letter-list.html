<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../services/letter-service.html">
<link rel="import" href="letter-card.html">

<dom-module id="letter-list">
  <style>
    :host {
      display: inline-block;
      position: relative;
    }
  </style>
  <template>
    <letter-service id="lservice" currlang="{{langCode}}" lobj="{{lobj}}"></letter-service>
    <div id="lmc" class="horizontal layout flex wrap" style="width: 100vw">
      <template id="repeater" is="x-repeat" items="{{letterList}}">
        <letter-card
          class="letter-matrix"
          uid="[[item.uid]]"
          aac-audio="[[item.audio]]"
          letter="[[item.letter]]"
          currlang="[[item.currlang]]"
          regular="[[item.regular]]"
          hidden="[[item.hidden]]">
          <p>[[item.letter]]</p>
        </letter-card>
      </template>
    </div>
  </template>
</dom-module>
<script>
(function() {
  Polymer({
    is: "letter-list",
    properties: {
      limit: {
        type: Number,
        value: 12
      },
      clicked: {
        type: Number,
        notify: true
      },
      langCode: {
        type: String,
        notify: true
      },
      filterWord: {
        type: Array,
        notify: true,
        value: function() { return []; }
      },
      letterList: {
        type: Array,
        notify: true,
        value: function() { return []; }
      },
      allLettersList: {
        type: Array,
        notify: true,
        value: function() { return []; }
      },
      setWord: {
        type: Boolean,
        value: false,
        notify: true
      }
    },
    listeners: {
      'new-letters': 'onNewLetters',
      'lang-code-changed': 'changeLanguage',
      'filter-word-changed': 'onNewWord'
    },
    created: function() {
    },
    attached: function() {
    },
    ready: function() {
    },
    changeLanguage: function(event) {
      this.$.lservice.currlang = this.langCode;
    },
    filterResults: function(items) {
      if(Object.keys(items).length === 0) {
        console.log("hmm, you've got an empty dataset");
      } else {
        var lang = items.lang.code;
        this.langCode = lang;
        items.alphabet.forEach(function(entry, i, array) {
          entry.currlang = lang;
          array[i].currlang = lang;
          array[i].audio = computeAacAudio(entry);
          array[i].hidden = false;
        });
      }
      return items.alphabet;
    },
    onNewLetters: function() {
      this.allLettersList = this.filterResults(this.$.lservice.lobj);
        this.async(function() {
          console.log("new letters async...");
          var wordBoardBox = document.querySelector('word-board');
          if(this.setWord) {
              if(this.filterWord.length === 0) {
                this.filterWord = wordBoardBox.wordArray[wordBoardBox.ranWordIndex];
                //this.onNewWord2([wordBoardBox.wordArray[wordBoardBox.ranWordIndex][0],wordBoardBox.wordArray[wordBoardBox.ranWordIndex][1]]);
              }
              this.shuffleLetters(this.filterWord[1]);
          } else {
            if(this.filterWord.length === 0) {
              console.log("filterWord not set yet");
              this.filterWord = wordBoardBox.wordArray[wordBoardBox.ranWordIndex];
              //this.onNewWord2([wordBoardBox.wordArray[wordBoardBox.ranWordIndex][0],wordBoardBox.wordArray[wordBoardBox.ranWordIndex][1]]);
            }
          }
        });
    },
    onNewWord: function() {
      var word = this.filterWord;
      if(word !== undefined && word.length !== 0) {
        console.log("fired filter-word-changed: " + word[0] + " | ohneAccent: " + word[1]);
        this.setWord = true;
        if(this.allLettersList.length > 0) {
          this.shuffleLetters(word[1]);
        } else {
          console.log("this.letterList is not yet set :-/");
        }
      }
    },
    shuffleLetters: function(word) {
      // this is a hack because polymer doesn't update if an array's properties have changed only if the array itself
      // has been manipulated.
      // see http://stackoverflow.com/questions/23706775/polymer-changes-not-always-flowing-through-a-filter
      var dummyArray = [];
      var numTiles = this.limit;
      numTiles = numTiles - word.split("").filter(function(value, index, self){ return self.indexOf(value) === index;}).length;
      shuffle(this.allLettersList);
      this.allLettersList.forEach(function(value, index) {
        if(value.letter === "!!!" || value.letter === undefined) {
          //do nothing
        } else if(word.indexOf(value.letter) > -1) {
          value.hidden = false;
          dummyArray.push(value);
        } else if(numTiles > 0 && value.regular !== false) {
          value.hidden = false;
          dummyArray.push(value);
          numTiles--;
        } else {
          value.hidden = true;
        }
      });
      this.letterList = dummyArray;
    }
  });
  function shuffle(array) {
    if(array instanceof Array) {
      var currentIndex = array.length, temporaryValue, randomIndex ;
    
      // While there remain elements to shuffle...
      while (0 !== currentIndex) {
    
        // Pick a remaining element...
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex -= 1;
    
        // And swap it with the current element.
        temporaryValue = array[currentIndex];
        array[currentIndex] = array[randomIndex];
        array[randomIndex] = temporaryValue;
      }
      return array;
    } else {
      console.log("You're trying to shuffle something that is not an array.");
      return array;
    }
  }
  function computeAacAudio(item) {
    if(item.letter === "!!!" || item.currlang === undefined) return "";
    return "/assets/audio/"+ item.currlang +"/" + item.letter + ".m4a";
  }

})();
</script>