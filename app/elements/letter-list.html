<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../services/letter-service.html">
<link rel="import" href="letter-card.html">

<dom-module id="letter-list">
  <style>
    :host {
      display: inline-block;
      position: relative;
    }
  </style>
  <template>
    <letter-service id="lservice" currlang="{{langCode}}" lobj="{{lobj}}"></letter-service>
    <div id="lmc" class="horizontal layout flex wrap" style="width: 100vw">
      <template id="repeater" is="x-repeat" filter="addIndex" items="{{letterList}}">
        <letter-card
          class="letter-matrix"
          uid="[[item.uid]]"
          aac-audio="[[item.audio]]"
          letter="[[item.letter]]"
          currlang="[[item.currlang]]"
          regular="[[item.regular]]"
          hidden="[[item.hidden]]"
          tabindex="[[item.index]]">
          <p>[[item.letter]]</p>
        </letter-card>
      </template>
    </div>
  </template>
</dom-module>
<script>
(function() {
  Polymer({
    is: "letter-list",
    properties: {
      limit: {
        type: Number,
        value: 12
      },
      clicked: {
        type: Number,
        notify: true
      },
      langCode: {
        type: String,
        notify: true
      },
      letterList: {
        type: Array,
        notify: true,
        value: function() { return []; }
      },
      allLettersList: {
        type: Array,
        notify: true,
        value: function() { return []; }
      },
      setWord: {
        type: Boolean,
        value: false,
        notify: true
      },
      setLetters: {
        type: Boolean,
        value: false,
        notify: true
      },
      stripDiacritics: {
        type: Boolean,
        value: true
      },
      pageRevealed: {
        type: Boolean,
        value: false
      },
      itemIndex: {
        type: Number,
        value: 1
      }
    },
    listeners: {
      'new-letters': 'onNewLetters',
      'lang-code-changed': 'changeLanguage',
      'set-letters-changed': 'runLetters',
      'set-word-changed': 'runLetters'
    },
    created: function() {
    },
    attached: function() {
    },
    addIndex: function(item) {
      item.index = this.itemIndex;
      this.itemIndex++;
      return item;
    },
    init: function() {
      this.wordBoardBox = document.querySelector('word-board');
      this.webapp = document.querySelector('tinavg-webapp');
    },
    changeLanguage: function(event) {
      this.$.lservice.currlang = this.langCode;
    },
    runLetters: function() {
      if(!this.wordBoardWord) this.init();
      if(this.setWord) {
        this.onNewWord();
      }
      if(this.setWord && this.setLetters) {
        this.runNewLetters();
        this.setWord = false;
        this.setLetters = false;
      }
    },
    filterResults: function(items) {
      if(Object.keys(items).length === 0) {
        console.log("hmm, you've got an empty dataset");
      } else {
        var lang = items.lang.code;
        this.langCode = lang;
        this.stripDiacritics = items.lang.stripDiacritics;
        items.alphabet.forEach(function(entry, i, array) {
          entry.currlang = lang;
          array[i].currlang = lang;
          array[i].audio = computeAacAudio(entry);
          array[i].hidden = false;
        });
      }
      return items.alphabet;
    },
    onNewLetters: function() {
      this.allLettersList = this.filterResults(this.$.lservice.lobj);
      this.setLetters = true;
    },
    runNewLetters: function(){
      console.log("switching up letters");
      this.shuffleLetters(this.wordBoardBox.getCheckWord().toLowerCase());
    },
    onNewWord: function() {
      this.itemIndex = 1;
      var word = this.wordBoardBox.getCheckWord();
      if(word !== undefined && word.length !== 0) {
        console.log("fired filter-word-changed: " + word + " | ohneAccent: " + this.stripDiacritics);
        this.setWord = true;
        if(this.allLettersList.length > 0) {
          this.shuffleLetters(word.toLowerCase());
        } else {
          console.log("this.letterList is not yet set :-/");
        }
      }
    },
    shuffleLetters: function(word) {
      if(!this.pageRevealed) {
        if(document.body.hasAttribute("unresolved")) this.pageRevealed = true;
        document.body.removeAttribute("unresolved");
        this.init();
        this.webapp.init();
        /* gonna move this to index.html
        window.viewportUnitsBuggyfill.init({
          refreshDebounceWait: 50,
          hacks: window.viewportUnitsBuggyfillHacks
        });
        */
      }
      // this is a hack because polymer doesn't update if an array's properties have changed only if the array itself
      // has been manipulated.
      // see http://stackoverflow.com/questions/23706775/polymer-changes-not-always-flowing-through-a-filter
      var dummyArray = [];
      var numTiles = this.limit;
      numTiles = numTiles - word.split("").filter(function(value, index, self){ return self.indexOf(value) === index;}).length;
      shuffle(this.allLettersList);
      this.allLettersList.forEach(function(value, index) {
        if(value.letter === "!!!" || value.letter === undefined) {
          //do nothing
        } else if(word.indexOf(value.letter) > -1) {
          value.hidden = false;
          dummyArray.push(value);
        } else if(numTiles > 0 && value.regular !== false) {
          value.hidden = false;
          dummyArray.push(value);
          numTiles--;
        } else {
          value.hidden = true;
        }
      });
      this.letterList = shuffle(dummyArray);
      this.webapp.letterLimit = this.letterList.length;
      this.webapp.jumbotronIndex = this.letterList.length + 1;
      
    }
  });
  function shuffle(array) {
    if(array instanceof Array) {
      var currentIndex = array.length, temporaryValue, randomIndex ;
    
      // While there remain elements to shuffle...
      while (0 !== currentIndex) {
    
        // Pick a remaining element...
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex -= 1;
    
        // And swap it with the current element.
        temporaryValue = array[currentIndex];
        array[currentIndex] = array[randomIndex];
        array[randomIndex] = temporaryValue;
      }
      return array;
    } else {
      console.log("You're trying to shuffle something that is not an array.");
      return array;
    }
  }
  function computeAacAudio(item) {
    if(item.letter === "!!!" || item.currlang === undefined) return "";
    return "/assets/audio/"+ item.currlang +"/" + item.letter + ".m4a";
  }

})();
</script>