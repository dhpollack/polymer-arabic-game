<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../services/letter-service.html">
<link rel="import" href="letter-card.html">

<dom-module id="letter-list">
  <style>
    :host {
      display: inline-block;
      position: relative;
    }
  </style>
  <template>
    <letter-service id="lservice" currlang="{{langCode}}" lobj="{{lobj}}"></letter-service>
    <div class="letter-matrix-container">
      <template id="repeater" is="x-repeat" items="{{letterList}}">
        <letter-card
          class="letter-matrix"
          uid="[[item.uid]]"
          audio="[[item.audio]]"
          letter="[[item.letter]]"
          currlang="[[item.currlang]]"
          can-opus="[[item.canOpus]]"
          hidden="{{item.hidden}}">
          <p>[[item.letter]]</p>
        </letter-card>
      </template>
    </div>
  </template>
</dom-module>
<script>
(function() {
  Polymer({
    is: "letter-list",
    properties: {
      limit: {
        type: Number,
        value: 12
      },
      clicked: {
        type: Number,
        notify: true
      },
      langCode: {
        type: String,
        notify: true,
        value: "es"
      },
      canOpus: {
        type: Boolean,
        value: false,
        reflectToAttribute: true
      },
      filterWord: {
        type: String,
        notify: true,
        value: 'مرحبا',
      },
      letterList: {
        type: Array,
        notify: true,
        value: function() { return []; }
      },
      saveSet: {
        type: Boolean,
        value: true
      }
    },
    listeners: {
      'new-letters': 'onNewLetters',
    },
    created: function() {
    },
    attached: function() {
    },
    onNewLetters: function(event) {
      //console.log("new-letters was fired and heard by letters-list: " + this.langCode);
      //this.currlang = event.detail.jsonLang;
      console.log("now the new language is: " + event.detail.jsonLang);
    },
    changeLanguage: function(event) {
      //console.log("Event: " + event.type + "\nFrom: " + event.srcElement.localName);
      //this.currlang = (this.currlang == "ar") ? "en" : "ar";
    },
    filterResults: function(items, word, lang, save) {
      var numTiles = this.limit;
      console.log("letter-list.filterResults().word: " + word);
      word = stripDiacritics(word);
      console.log("stripped word: " + word);
      if(Object.keys(items).length === 0) {
        console.log("hmm, you've got an empty dataset");
      } else {
        shuffle(items.alphabet);
        if(lang === items.lang.code) {
          numTiles = numTiles - word.split("").filter(function(value, index, self){ return self.indexOf(value) === index;}).length;
        }
        var opus = checkOpus();
        items.alphabet.forEach(function(entry, i) {
          entry.currlang = items.lang.code;
          entry.canOpus = opus;
          if(word.indexOf(entry.letter) > -1) {
            entry.hidden = false;
          } else if(numTiles > 0) {
            entry.hidden = false;
            numTiles--;
          } else {
            entry.hidden = true;
          }
        });
      }
      return items.alphabet;
    },
    onNewLetters: function() {
      console.log("caught new letters");
      this.letterList = this.filterResults(this.$.lservice.lobj, this.filterWord, this.langCode, this.saveSet);
    },
    onNewWord2: function(word) {
      console.log("caught new word2: " + word);
      this.filterWord = word;
      if(this.letterList.length > 0) this.shuffleLetters(word);
    },
    shuffleLetters: function(word) {
      var stripped = stripDiacritics(word);
      console.log("code: "+ word.charCodeAt(0));
      console.log("no accents: " + word + "|" + stripDiacritics(word) + "|" + stripped);
      var letterCards = document.querySelectorAll('letter-card.letter-matrix');
      var letterParent = letterCards[0].parentNode;
      console.log(letterParent);
      var numTiles = this.limit;
      numTiles = numTiles - word.split("").filter(function(value, index, self){ return self.indexOf(value) === index;}).length;
      for(var i = 0; i < letterCards.length; i++) {
        letterParent.appendChild(letterParent.children[Math.random() * i | 0]);
        if(letterCards[i].letter === " ") {
          //do nothing for spacebar
        } else if(word.indexOf(letterCards[i].letter) > -1) {
          letterCards[i].hidden = false;
        } else if(numTiles > 0) {
          letterCards[i].hidden = false;
          numTiles--;
        } else {
          letterCards[i].hidden = true;
        }
      }
    }
  });
  function checkOpus() {
    var audioTag = document.createElement("audio");
    if(!!(audioTag.canPlayType && audioTag.canPlayType('audio/ogg;codecs="opus"').replace(/no/, ''))) {
      return true;
    } else {
      return false;
    }
  }
  function stripDiacritics(r) {
    return r.replace(new RegExp("[\u064b-\u0653\u0670]", 'g'),"");
  }
  function shuffle(array) {
    if(array instanceof Array) {
      var currentIndex = array.length, temporaryValue, randomIndex ;
    
      // While there remain elements to shuffle...
      while (0 !== currentIndex) {
    
        // Pick a remaining element...
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex -= 1;
    
        // And swap it with the current element.
        temporaryValue = array[currentIndex];
        array[currentIndex] = array[randomIndex];
        array[randomIndex] = temporaryValue;
      }
      return array;
    } else {
      console.log("You're trying to shuffle something that is not an array.");
      return array;
    }
  }

})();
</script>