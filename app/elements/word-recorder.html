<link rel="import" href="../../bower_components/polymer/polymer.html">
<!-- Additional Component Load -->
<link rel="import" href="../../bower_components/core-icons/core-icons.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/core-icons/av-icons.html">
<script src="../../bower_components/recordrtc/RecordRTC.js"></script>

<dom-module id="word-recorder">
    <style>
    .recording-on {
      background-color: rgba(255, 50, 50, 0.6);
      border-radius: 50%;
    }
    </style>
    <template>
      <div id="record-elem">
        <audio id="recAudio" src="" hidden></audio>
        <paper-icon-button id="recorderInit" icon="av:mic" on-tap="makeRecording"></paper-icon-button>
        <paper-icon-button id="recorderPlay" icon="av:play-circle-fill" on-tap="playRecording"></paper-icon-button>
      </div>
    </template>
</dom-module>
<script>
(function() {
  Polymer({
    is: 'word-recorder',
    properties: {
    },
    ready: function() {
      this.scoreBoard = document.getElementById("score-board-player-1").querySelector("core-icon");
      this.audio = this.$.recAudio;
      this.recordIcon = Polymer.dom(this.root).querySelector("#recorderInit");
    },
    makeRecording: function() {
      if(initRec(this.audio)) {
        this.scoreBoard.style.color = "yellow";
        this.recordIcon.classList.add("recording-on");
      } else {
        this.recordIcon.classList.remove("recording-on");
      }
    },
    playRecording: function() {
      if(playRec(this.audio)) {
        this.recordIcon.classList.remove("recording-on");
      } else {
        this.scoreBoard.style.color = "green";
      }
    }  
  });
  /* RecordRTC Scripts */
  var recorder;
  var audioStream;
  var preventLongRec;
  var recLimit = 15000;
  function initRec(audioElem) {
    if(!audioStream) {
      // sets up recording environment
      navigator.getUserMedia(
        {audio: true},
        function(stream) {
          console.log("streaming started...");
          if (window.IsChrome) {
            stream = new window.MediaStream(stream.getAudioTracks());
          }
          audioStream = stream;
          
          // "audio" is a default type
          recorder = window.RecordRTC(stream, {
              type: 'audio'
          });
          startRec(audioElem);
        },
        function() { 
          console.log("there was an error recording...");
        }
      );
      return true;  
    } else {
      if(audioElem.readyState === 0) {
        clearTimeout(preventLongRec);
        stopRec(audioElem);
        return false;
      } else {
        audioElem.src = '';
        startRec(audioElem);
        return true;
      }
    }
  }
  function startRec(audioElem) {
    recorder.startRecording();
    preventLongRec = setTimeout(function() {
        stopRec(audioElem);
        console.log("recording timed out after " + (recLimit / 1000) + " seconds.");
      }, recLimit);
  }
  function stopRec(audioElem) {
    if(recorder && audioElem.readyState === 0) {
      
      recorder.stopRecording(function(url) {
        console.log("audio data url: " + url);
        audioElem.src = url;
        audioElem.muted = false;
        clearTimeout(preventLongRec);
      });
    } else {
      console.log("hmm, recorder isn't recording");
    }
  }
  function playRec(audioElem) {
    // if the user presses play before stop, the recording is stopped and then played
    if(audioElem.readyState === 0) {
      stopRec(audioElem);
      audioElem.onloadeddata = function() { 
        audioElem.play();
        audioElem.onloadeddata = function() {};
      };
      return true;
    } else {
      console.log("play recording...");
      audioElem.play();
      return false;
    }
  }
})();
</script>