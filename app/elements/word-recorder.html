<link rel="import" href="../../bower_components/polymer/polymer.html">
<!-- Additional Component Load -->
<link rel="import" href="../../bower_components/core-icons/core-icons.html">
<link rel="import" href="../../bower_components/core-icons/av-icons.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<script src="../../bower_components/recordrtc/RecordRTC.js"></script>

<dom-module id="word-recorder">
    <style>
    </style>
    <template>
      <div>
        <audio id="recAudio" src="" controls hidden></audio>
        <paper-icon-button id="recorderInit" icon="av:mic" on-tap="startRecording"></paper-icon-button>
        <paper-icon-button id="recorderStop" icon="av:stop" on-tap="stopRecording"></paper-icon-button>
        <paper-icon-button id="recorderPlay" icon="av:play-circle-fill" on-tap="playRecording"></paper-icon-button>
      </div>
    </template>
</dom-module>
<script>
(function() {
  Polymer({
    is: 'word-recorder',
    properties: {
    },
    ready: function() {
      this.audio = this.$.recAudio;
    },
    startRecording: function() {
      var aud = this.audio;
      var recLimit = 25000;
      startRecording(aud);
      preventLongRec = setTimeout(function() {
          stopRecording(aud);
          console.log("recording timed out after " + (recLimit / 1000) + " seconds.");
        }, recLimit);
    },
    stopRecording: function() {
      stopRecording(this.audio);
    },
    playRecording: function() {
      
      playRecording(this.audio);
    }  
  });
  /* RecordRTC Scripts */
  var recorder;
  var audioStream;
  var preventLongRec;
  function startRecording(audioElem) {
    if(!audioStream) {
      console.log("start recording...");
      navigator.getUserMedia(
        {audio: true},
        function(stream) {
          console.log("streaming started...");
          if (window.IsChrome) {
            stream = new window.MediaStream(stream.getAudioTracks());
          }
          audioStream = stream;
          
          // "audio" is a default type
          recorder = window.RecordRTC(stream, {
              type: 'audio'
          });
          recorder.startRecording();
        },
        function() { console.log("there was an error recording..."); } );
    } else {
      console.log("Recording overwriting...");
      clearTimeout(preventLongRec);
      recorder.stopRecording();
      if (recorder) recorder.startRecording();
    }
  }
  function stopRecording(audioElem) {
    audioElem.src = '';
    if(recorder && recorder.getBlob() === undefined) {
      recorder.stopRecording(function(url) {
        console.log("audio data url: " + url);
        audioElem.src = url;
        audioElem.muted = false;
        clearTimeout(preventLongRec);
      });
    } else {
      console.log("hmm, recorder isn't recording");
    }
  }
  function playRecording(audioElem) {
    // if the user presses play before stop, the recording is stopped and then played
    if(recorder.getBlob() === undefined) {
      stopRecording(audioElem);
      audioElem.onloadeddata = function() { playRecording(audioElem); };
    } else {
      console.log("play recording...");
      audioElem.play();
    }
  }
})();
</script>